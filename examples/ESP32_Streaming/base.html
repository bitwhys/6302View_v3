<!doctype html>
<html>
<head>

  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="/src/js/packery.pkgd.min.js"></script>
  <script src="/src/js/draggabilly.pkgd.min.js"></script>
  <script src="/src/js/socket.io.js"></script>
  <script src="/src/js/nouislider.min.js" ></script>
  <script src="/src/js/time_series.js" ></script>
  <script src="/src/js/pushbutton.js" ></script>
  <script src="/src/js/toggle.js" ></script>
  <script src="/src/js/slider.js" ></script>
  <script src="/src/js/wNumb.js" ></script>
  <script src="/src/js/numerical_reporter.js" ></script>
  <link rel="stylesheet" type="text/css" href="/src/css/checkboxes.min.css">
  <link rel="stylesheet" type="text/css" href="/src/css/nouislider.min.css">
  <link rel="stylesheet" type="text/css" href="/src/css/gui.css">
</head>

<body>
<h1>6302View</h1>
<p><i>Enter the IP address printed from your microcontroller's Serial readout here, press Submit/Connect, and start working.</i></p>
<p>Local IP: <input type="text" name="ipaddress" id="ipaddress"/><button id="ipsubmit">Submit/Connect</button></p>
<div style="height:100px;">
<div style="float:left;width:200px;">
<h3 id="grid_status">Grid Locked</h3>
<div class="ckbx-style-8">
    <input type="checkbox" id="grid_lock" name="hey">
    <label for="grid_lock"></label>
</div>
</div>
<div style="float:left;width:200px;">
<h3 id="grid_status">CSV Generate?</h3>
<div class="ckbx-style-8">
    <input type="checkbox" id="csv_enable" value="1" name="csv_enable">
    <label for="csv_enable"></label>
</div>
</div>
</div>

<div class="cp">
  <div class="cp-item" id="plotbox"></div>
  <div class="cp-item" id="plotbox2"></div>
  <div class="cp-item" id="sliderbox1"></div>
  <div class="cp-item" id="sliderbox2"></div>
  <div class="cp-item" id="togglebox1"></div>
  <div class="cp-item" id="togglebox2"></div>
  <!--<div class="cp-item" id="toggle1"></div>-->
</div>


<script>
/*

    <input type="checkbox" id="ckbx-style-8-1" value="1" name="hey" onclick="LockToggle()">
    <label for="ckbx-style-8-1"></label>
*/

//Use these when laying out colors!
var standard_colors = ["blue","red","green","yellow","purple"];

var mouseX=0;
var mouseY = 0;
document.addEventListener("mousemove",function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
});
var PLOT_HEIGHT = 200;
var PLOT_WIDTH = 300;
var plot;
var plot2;
var pb1;
var pb2;
var pb3;
var toggle_1;

var reporter_x;
var reporter_y;
var reporter_x2;
var reporter_y2;


var IDLE = 0;
var BUILDING = 1; 
var UPDATE =2;
var RUNNING = 3;

var system_state = IDLE;

var data_for_csv=[];

var sliders = []; //array of hooks to slider objects.
var toggles = []; //array of hooks for toggle objects
var plots = []; //array of hooks for plot objects

window.onload = function(){
    var unique = 456;
    plot = new Time_Series("plotbox",'Accelerations',PLOT_WIDTH, PLOT_HEIGHT,60,[-100,100],3,["green","yellow","blue"],unique);
    plot2 = new Time_Series("plotbox2",'Mouse Moves',PLOT_WIDTH, PLOT_HEIGHT,60,[0,1000],2,["red","blue"],unique+1);
    slider1 = new Slider("sliderbox1","Things",0,10,0.1,true,unique+2);
    slider2 = new Slider("sliderbox2","Kp",0,10,0.1,false,unique+3);
    toggle1 = new Toggle("togglebox1","Cat",unique+4);
    toggle2 = new Toggle("togglebox2","Large Fire Trigger", unique+5);
    //pb1  = new PushButton("toggle1",123123,"Fire","Red","Black");
    timer = setInterval(function(){
        plot2.step([[mouseX],[mouseY]]);
    }, 10);
}


document.getElementById("ipsubmit").addEventListener("mousedown",function(){
    var ip = document.getElementById("ipaddress").value; //collect the ip address
    //Should add in some checker/an alert that comes up if you can't actually connect.
    var ws = new WebSocket("ws://"+ip); //create new websocket to the ip of interest
    ws.onopen = function(){
      // Web Socket is connected, send data using send()
      ws.send("Parameter Request");
      console.log("Message is sent...");
    }; 
    ws.onmessage = function (evt) { 
      console.log("got it");
      var received_msg = evt.data;
      console.log(received_msg);
      plot.step(eval(received_msg));
    };
    //timer2 = setInterval(function(){
    //    ws.send("Parameter Request");
    //}, 50);
 
    ws.onclose = function(){ 
      // websocket is closed.
      console.log("Connection is closed..."); 
    };
});

var MessageParser = function(evt){
    console.log("message received");
    var received_msg = evt.data;
    console.log(received_msg);
    switch (system_state){
        case IDLE:
            if (received_msg==="BUILDING"){
                system_state = BUILDING;
                sliders = [];
                toggles = [];
                plots = [];
                WipeGUI();
            }
        case BUILDING:
            if (received_msg==="END"){
                system_state = UPDATE;
            }
        case UPDATE:

        case RUNNING:

    }
};

var WipeGUI = function(){


};

/* Based off of code from here:
https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
*/
var ExportCSV = function(filename, rows) {
    var processRow = function (row) {
        var finalVal = '';
        for (var j = 0; j < row.length; j++) {
            var innerValue = row[j] === null ? '' : row[j].toString();
            if (row[j] instanceof Date) {
                innerValue = row[j].toLocaleString();
            };
            var result = innerValue.replace(/"/g, '""');
            if (result.search(/("|,|\n)/g) >= 0)
                result = '"' + result + '"';
            if (j > 0)
                finalVal += ',';
            finalVal += result;
        }
        return finalVal + '\n';
    };

    var csvFile = '';
    for (var i = 0; i < rows.length; i++) {
        csvFile += processRow(rows[i]);
    }

    var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
    if (navigator.msSaveBlob) { // IE 10+
        navigator.msSaveBlob(blob, filename);
    } else {
        var link = document.createElement("a");
        if (link.download !== undefined) { // feature detection
            // Browsers that support HTML5 download attribute
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
}


</script>

<script src="/src/js/draggable.js"></script>

</body>
</html>
